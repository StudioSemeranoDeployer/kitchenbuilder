<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>3D Kitchen Builder - Fix</title>
    <style>
        /* STILI BASE */
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #2c3e50; }
        
        /* SCHERMATA CARICAMENTO */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; color: white; display: flex; 
            justify-content: center; align-items: center; font-size: 24px;
            z-index: 9999;
        }

        /* UI ELEMENTS */
        #info-panel {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            pointer-events: none; max-width: 250px;
        }
        
        #btn-screenshot {
            position: absolute; top: 20px; right: 20px;
            background: #e74c3c; color: white; border: none;
            padding: 10px 15px; border-radius: 5px; cursor: pointer;
            font-weight: bold; z-index: 100;
        }

        #bom-panel {
            position: absolute; bottom: 20px; right: 20px;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            width: 300px; max-height: 250px; overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        td, th { text-align: left; padding: 5px; border-bottom: 1px solid #ddd; }
    </style>

    <!-- MAPPA IMPORTAZIONI THREE.JS -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- VISUALIZZA QUESTO SE QUALCOSA SI BLOCCA -->
    <div id="loader">Caricamento 3D in corso...</div>

    <div id="info-panel">
        <h3>Cucina 3D</h3>
        <p>Clicca sui mobili per modificarli.</p>
    </div>

    <button id="btn-screenshot">ðŸ“· Foto</button>

    <div id="bom-panel">
        <div id="total-width" style="font-weight:bold; margin-bottom:10px;">Larghezza: 0 cm</div>
        <table id="bom-table"><tbody></tbody></table>
    </div>

    <script type="module">
        // GESTIONE ERRORI GLOBALE (Se non vedi nulla, appare l'alert)
        window.onerror = function(msg, url, line) {
            alert("Errore Javascript: " + msg + "\nLinea: " + line);
            document.getElementById('loader').innerText = "ERRORE: " + msg;
        };

        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

        let scene, camera, renderer, controls;
        let raycaster, mouse;
        let cabinets = [];
        let selectedCabinet = null;
        let selectionHelper;

        const materials = {
            wood: new THREE.MeshStandardMaterial({ color: 0xE6CDA5 }),
            top: new THREE.MeshStandardMaterial({ color: 0x333333 }),
            handle: new THREE.MeshStandardMaterial({ color: 0xcccccc }),
            kick: new THREE.MeshStandardMaterial({ color: 0x111111 })
        };

        // --- PARAMETRI GUI ---
        const params = {
            type: 'base', width: 60, height: 85, depth: 60, elevation: 0, isOpen: false,
            addBase: () => addCabinet('base'),
            addWall: () => addCabinet('wall'),
            addTall: () => addCabinet('tall'),
            del: () => deleteCab()
        };
        const gui = new GUI({ title: 'Menu' });
        gui.domElement.style.top = "60px";
        const ctrls = {};

        init();

        function init() {
            try {
                // 1. SCENA
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xe0e0e0);

                // 2. CAMERA (Assonometrica)
                const aspect = window.innerWidth / window.innerHeight;
                const d = 400;
                camera = new THREE.OrthographicCamera(-d * aspect, d * aspect, d, -d, 1, 2000);
                camera.position.set(500, 400, 500);
                camera.lookAt(0, 0, 0);

                // 3. RENDERER
                renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                document.body.appendChild(renderer.domElement);

                // 4. LUCI
                const ambLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambLight);
                const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                dirLight.position.set(200, 500, 300);
                dirLight.castShadow = true;
                scene.add(dirLight);

                // 5. CONTROLLI
                controls = new OrbitControls(camera, renderer.domElement);
                scene.add(new THREE.GridHelper(1000, 50));

                // 6. RAYCASTER
                raycaster = new THREE.Raycaster();
                mouse = new THREE.Vector2();
                selectionHelper = new THREE.BoxHelper(new THREE.Mesh(), 0xff0000);
                scene.add(selectionHelper);

                // GUI SETUP
                setupGui();

                // EVENTI
                window.addEventListener('resize', onResize);
                renderer.domElement.addEventListener('pointerdown', onClick);
                document.getElementById('btn-screenshot').addEventListener('click', takePhoto);

                // AVVIO
                addCabinet('base');
                addCabinet('tall');
                
                // Nascondi loader se tutto ok
                document.getElementById('loader').style.display = 'none';
                
                animate();

            } catch (e) {
                alert("Errore Inizializzazione: " + e.message);
            }
        }

        // --- LOGICA ---

        // Funzione sicura per ID random (sostituisce crypto.randomUUID)
        function generateID() {
            return 'id-' + Math.random().toString(36).substr(2, 9);
        }

        function createMesh(p) {
            const grp = new THREE.Group();
            
            // Variabili dimensionali
            let hBody = p.height;
            let yPos = hBody / 2;
            let toeH = 0;

            if(p.type !== 'wall') {
                toeH = 10;
                hBody -= toeH;
                yPos = toeH + hBody / 2;
            }
            if(p.type === 'base') hBody -= 4; // Spazio top

            // Box Mobile
            const box = new THREE.Mesh(new THREE.BoxGeometry(p.width, hBody, p.depth), materials.wood);
            box.position.y = yPos;
            box.castShadow = true;
            grp.add(box);

            // Anta
            const door = new THREE.Mesh(new THREE.BoxGeometry(p.width-0.5, hBody-0.5, 2), materials.wood);
            const doorGrp = new THREE.Group();
            door.position.set(p.width/2, 0, 0); // Sposta centro geometry
            doorGrp.add(door);
            doorGrp.position.set(-p.width/2, yPos, p.depth/2 + 1);
            
            // Maniglia
            const han = new THREE.Mesh(new THREE.BoxGeometry(2, 10, 2), materials.handle);
            han.position.set(p.width - 5, 0, 2);
            doorGrp.add(han);

            if(p.isOpen) doorGrp.rotation.y = -Math.PI / 2;
            grp.add(doorGrp);

            // Top (solo base)
            if(p.type === 'base') {
                const top = new THREE.Mesh(new THREE.BoxGeometry(p.width, 4, p.depth+2), materials.top);
                top.position.y = toeH + hBody + 2;
                top.position.z = 1;
                grp.add(top);
            }

            // Zoccolo
            if(toeH > 0) {
                const kick = new THREE.Mesh(new THREE.BoxGeometry(p.width, toeH, p.depth-5), materials.kick);
                kick.position.set(0, toeH/2, -2.5);
                grp.add(kick);
            }

            return grp;
        }

        function addCabinet(type) {
            const defaults = { base:[85,0], wall:[72,145], tall:[210,0] };
            const cfg = {
                id: generateID(),
                type: type,
                width: 60,
                height: defaults[type][0],
                depth: (type==='wall' ? 35 : 60),
                elevation: defaults[type][1],
                isOpen: false
            };
            
            const mesh = createMesh(cfg);
            mesh.userData = { isCab: true, id: cfg.id };
            mesh.position.y = cfg.elevation;
            
            scene.add(mesh);
            cabinets.push({ mesh, params: cfg });
            
            updateLayout();
            select(cabinets[cabinets.length-1]);
        }

        function updateLayout() {
            let cx = 0;
            // Calcola larghezza totale
            const totW = cabinets.reduce((s,c)=>s+c.params.width,0);
            cx = -totW / 2; // Inizia da sinistra

            cabinets.forEach(c => {
                c.mesh.position.x = cx + c.params.width/2;
                c.mesh.position.y = c.params.elevation;
                cx += c.params.width;
            });

            // Aggiorna tabella
            const tb = document.querySelector('#bom-table tbody');
            tb.innerHTML = '';
            cabinets.forEach((c,i) => {
                tb.innerHTML += `<tr style="${selectedCabinet===c?'background:#ffd':''}">
                    <td>${i+1}. ${c.params.type.toUpperCase()}</td>
                    <td>${c.params.width}x${c.params.height}</td>
                </tr>`;
            });
            document.getElementById('total-width').innerText = "Larghezza Totale: " + totW + " cm";

            if(selectedCabinet) selectionHelper.setFromObject(selectedCabinet.mesh);
        }

        function updateSelected() {
            if(!selectedCabinet) return;
            const p = selectedCabinet.params;
            scene.remove(selectedCabinet.mesh);
            
            const m = createMesh(p);
            m.userData = { isCab: true, id: p.id };
            scene.add(m);
            selectedCabinet.mesh = m;
            
            updateLayout();
        }

        function deleteCab() {
            if(!selectedCabinet) return;
            scene.remove(selectedCabinet.mesh);
            cabinets = cabinets.filter(c => c !== selectedCabinet);
            selectedCabinet = null;
            selectionHelper.visible = false;
            updateLayout();
        }

        function onClick(e) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left)/rect.width)*2 -1;
            mouse.y = -((e.clientY - rect.top)/rect.height)*2 +1;
            
            raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(scene.children, true);
            
            let found = null;
            for(let h of hits) {
                let p = h.object;
                while(p) {
                    if(p.userData?.isCab) { found = p.userData.id; break; }
                    p = p.parent;
                }
                if(found) break;
            }

            if(found) select(cabinets.find(c=>c.params.id===found));
            else { selectedCabinet=null; selectionHelper.visible=false; updateLayout(); }
        }

        function select(c) {
            if(!c) return;
            selectedCabinet = c;
            ctrls.type.setValue(c.params.type);
            ctrls.w.setValue(c.params.width);
            ctrls.h.setValue(c.params.height);
            ctrls.d.setValue(c.params.depth);
            ctrls.elv.setValue(c.params.elevation);
            ctrls.opn.setValue(c.params.isOpen);
            selectionHelper.visible = true;
            updateLayout();
        }

        function setupGui() {
            const f1 = gui.addFolder('Aggiungi');
            f1.add(params, 'addBase').name('+ Base');
            f1.add(params, 'addTall').name('+ Armadio');
            f1.add(params, 'addWall').name('+ Pensile');

            const f2 = gui.addFolder('Modifica');
            ctrls.type = f2.add(params, 'type', ['base','wall','tall']).onChange(v=>{
                if(selectedCabinet) { selectedCabinet.params.type=v; updateSelected(); }
            });
            ctrls.w = f2.add(params, 'width', 15, 120, 5).onChange(v=>{
                if(selectedCabinet) { selectedCabinet.params.width=v; updateSelected(); }
            });
            ctrls.h = f2.add(params, 'height', 30, 250, 5).onChange(v=>{
                if(selectedCabinet) { selectedCabinet.params.height=v; updateSelected(); }
            });
            ctrls.d = f2.add(params, 'depth', 20, 80, 5).onChange(v=>{
                if(selectedCabinet) { selectedCabinet.params.depth=v; updateSelected(); }
            });
            ctrls.elv = f2.add(params, 'elevation', 0, 250, 5).onChange(v=>{
                if(selectedCabinet) { selectedCabinet.params.elevation=v; updateSelected(); }
            });
            ctrls.opn = f2.add(params, 'isOpen').name('Apri Ante').onChange(v=>{
                if(selectedCabinet) { selectedCabinet.params.isOpen=v; updateSelected(); }
            });
            f2.add(params, 'del').name('Elimina');
            f1.open(); f2.open();
        }

        function takePhoto() {
            render();
            const link = document.createElement('a');
            link.download = 'cucina.png';
            link.href = renderer.domElement.toDataURL('image/png');
            link.click();
        }

        function onResize() {
            const aspect = window.innerWidth/window.innerHeight;
            const d = 400;
            camera.left = -d*aspect; camera.right = d*aspect;
            camera.top = d; camera.bottom = -d;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            render();
        }
        function render() { renderer.render(scene, camera); }
    </script>
</body>
</html>